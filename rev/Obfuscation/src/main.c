#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include "/home/ubuntu/Downloads/tigress/3.1/tigress.h"
#define LIMIT 35

int init() {
	fclose(stderr);
	setvbuf(stdin,	0, 2, 0);
	setvbuf(stdout, 0, 2, 0);
}

struct tbl_entry {
	char src;
	char dst;
} trans_tbl[] = {
	{1, 120}, {2, 236}, {3, 142}, {4, 118}, {5, 44}, {6, 16}, 
	{7, 48}, {8, 173}, {9, 38}, {10, 197}, {11, 243}, {12, 201}, 
	{13, 104}, {14, 249}, {15, 188}, {16, 124}, {17, 66}, {18, 214}, 
	{19, 97}, {20, 186}, {21, 141}, {22, 81}, {23, 240}, {24, 126}, 
	{25, 88}, {26, 161}, {27, 202}, {28, 2}, {29, 62}, {30, 107}, 
	{31, 216}, {32, 56}, {33, 106}, {34, 68}, {35, 102}, {36, 162}, 
	{37, 167}, {38, 133}, {39, 160}, {40, 9}, {41, 143}, {42, 125}, 
	{43, 29}, {44, 224}, {45, 168}, {46, 23}, {47, 158}, {48, 49}, 
	{49, 215}, {50, 189}, {51, 90}, {52, 132}, {53, 35}, {54, 231}, 
	{55, 76}, {56, 185}, {57, 153}, {58, 123}, {59, 169}, {60, 113}, 
	{61, 246}, {62, 207}, {63, 60}, {64, 98}, {65, 239}, {66, 229}, 
	{67, 61}, {68, 244}, {69, 234}, {70, 25}, {71, 181}, {72, 251}, 
	{73, 225}, {74, 86}, {75, 85}, {76, 213}, {77, 42}, {78, 93}, 
	{79, 237}, {80, 41}, {81, 101}, {82, 108}, {83, 150}, {84, 77}, 
	{85, 155}, {86, 40}, {87, 199}, {88, 71}, {89, 178}, {90, 67}, 
	{91, 110}, {92, 32}, {93, 233}, {94, 163}, {95, 149}, {96, 206}, 
	{97, 180}, {98, 139}, {99, 172}, {100, 130}, {101, 187}, {102, 176}, 
	{103, 147}, {104, 211}, {105, 58}, {106, 105}, {107, 191}, {108, 51}, 
	{109, 226}, {110, 196}, {111, 37}, {112, 156}, {113, 55}, {114, 242}, 
	{115, 53}, {116, 230}, {117, 235}, {118, 228}, {119, 36}, {120, 136}, 
	{121, 91}, {122, 254}, {123, 209}, {124, 137}, {125, 138}, {126, 82}, 
	{127, 205}, {128, 95}, {129, 70}, {130, 39}, {131, 78}, {132, 83}, 
	{133, 114}, {134, 145}, {135, 8}, {136, 10}, {137, 103}, {138, 6}, 
	{139, 24}, {140, 80}, {141, 121}, {142, 73}, {143, 175}, {144, 122}, 
	{145, 72}, {146, 179}, {147, 174}, {148, 128}, {149, 203}, {150, 157}, 
	{151, 18}, {152, 119}, {153, 218}, {154, 248}, {155, 4}, {156, 192}, 
	{157, 116}, {158, 59}, {159, 195}, {160, 69}, {161, 1}, {162, 194}, 
	{163, 14}, {164, 31}, {165, 15}, {166, 129}, {167, 232}, {168, 21}, 
	{169, 134}, {170, 210}, {171, 170}, {172, 217}, {173, 89}, {174, 171}, 
	{175, 20}, {176, 200}, {177, 190}, {178, 115}, {179, 47}, {180, 221}, 
	{181, 255}, {182, 252}, {183, 75}, {184, 45}, {185, 184}, {186, 87}, 
	{187, 28}, {188, 109}, {189, 46}, {190, 220}, {191, 247}, {192, 219}, 
	{193, 54}, {194, 100}, {195, 112}, {196, 183}, {197, 63}, {198, 30}, 
	{199, 84}, {200, 79}, {201, 96}, {202, 52}, {203, 245}, {204, 146}, 
	{205, 13}, {206, 19}, {207, 238}, {208, 154}, {209, 111}, {210, 148}, 
	{211, 250}, {212, 140}, {213, 151}, {214, 27}, {215, 253}, {216, 43}, 
	{217, 26}, {218, 159}, {219, 34}, {220, 204}, {221, 33}, {222, 222}, 
	{223, 74}, {224, 182}, {225, 177}, {226, 57}, {227, 3}, {228, 152}, 
	{229, 135}, {230, 223}, {231, 166}, {232, 208}, {233, 117}, {234, 92}, 
	{235, 193}, {236, 17}, {237, 227}, {238, 64}, {239, 127}, {240, 241}, 
	{241, 212}, {242, 165}, {243, 7}, {244, 12}, {245, 94}, {246, 5}, 
	{247, 198}, {248, 50}, {249, 22}, {250, 11}, {251, 65}, {252, 131}, 
	{253, 144}, {254, 164}, {255, 99}, 
};

char get_tbl_entry(char c) {
	for (size_t i = 0; i < sizeof(trans_tbl) / sizeof(struct tbl_entry); i++) {
		if (trans_tbl[i].src == c)
			return trans_tbl[i].dst;
	}
	return 0;
}

bool check(char* input) {
	for (int j = 0; j < 3; j++) {
		for (int i = 0; i < LIMIT; i++) {
			input[i] = get_tbl_entry(input[i]);
		}
	}
	char buf[5];
	strncpy(buf, input, 5);
	buf[4] = '\0';
	int num = strtol(buf, NULL, 10);
	srand(num);
	unsigned char answer[LIMIT];
	for (int i = 0; i < LIMIT; i++) {
		answer[i] = input[i] ^ (unsigned char) rand();
	}
	unsigned char passphrase[LIMIT] = {165, 205, 255, 228, 233, 111, 250, 84, 190, 198, 135, 19, 253, 107, 249, 128, 196, 84, 228, 111, 88, 213, 35, 53, 173, 204, 33, 245, 147, 98, 12, 173, 90, 50, 13};
	for (int i = 0; i < LIMIT; i++) {
		if (answer[i] != passphrase[i]) {
			return false;
		}
	}
	return true;
}

int main() {
	char input[LIMIT];
	init();
	printf("What is the passphrase to unlock this program?\n> ");
	fgets(input, LIMIT, stdin);
	input[LIMIT - 1] = '\0';
	if (check(input)) {
		FILE *flagfile;
		char *flag;
		long numbytes;
		flagfile = fopen("flag.txt", "r");
		if (flagfile == NULL)
			return -1;
		fseek(flagfile, 0L, SEEK_END);
		numbytes = ftell(flagfile);
		fseek(flagfile, 0L, SEEK_SET);
		flag = (char *)calloc(numbytes, sizeof(char));
		if (flag == NULL)
			return -1;
		fread(flag, sizeof(char), numbytes, flagfile);
		fclose(flagfile);
		system("./script.sh");
		printf(flag);
	} 
	else {
		printf("Wrong passphrase!\n");
	}
	return 0;
}